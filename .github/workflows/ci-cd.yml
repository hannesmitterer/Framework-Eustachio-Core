name: CI/CD Pipeline - IPFS Testing & Performance

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Run IPFS integration tests
      run: npm test
      
    - name: Lint check
      run: npm run lint

  edge-case-testing:
    name: Edge Case Testing
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Test - Empty data handling
      run: |
        node -e "
        const IPFSClient = require('./ipfs-client.js');
        const client = new IPFSClient();
        client.addData('').catch(() => {
          console.log('✓ Empty data correctly rejected');
          process.exit(0);
        });
        setTimeout(() => process.exit(1), 1000);
        "
        
    - name: Test - Fallback mode
      run: |
        node -e "
        const IPFSClient = require('./ipfs-client.js');
        if (typeof localStorage === 'undefined') {
          global.localStorage = { storage: {}, setItem: function(k,v) { this.storage[k]=v; }, getItem: function(k) { return this.storage[k]; } };
        }
        const client = new IPFSClient();
        client.fallbackMode = true;
        client.addData('test').then(result => {
          if (result.mode === 'fallback') {
            console.log('✓ Fallback mode works correctly');
            process.exit(0);
          }
          process.exit(1);
        });
        "
        
    - name: Test - Network error detection
      run: |
        node -e "
        const IPFSClient = require('./ipfs-client.js');
        const client = new IPFSClient();
        const isNetwork = client.isNetworkError(new Error('network timeout'));
        if (isNetwork) {
          console.log('✓ Network errors correctly detected');
          process.exit(0);
        }
        process.exit(1);
        "

  performance-monitoring:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Monitor IPFS operation latency
      run: |
        node -e "
        const IPFSClient = require('./ipfs-client.js');
        if (typeof localStorage === 'undefined') {
          global.localStorage = { storage: {}, setItem: function(k,v) { this.storage[k]=v; }, getItem: function(k) { return this.storage[k]; } };
        }
        
        async function measurePerformance() {
          const client = new IPFSClient();
          client.fallbackMode = true; // Use fallback for consistent testing
          
          const iterations = 100;
          const start = Date.now();
          
          for (let i = 0; i < iterations; i++) {
            await client.addData('Performance test message ' + i);
          }
          
          const end = Date.now();
          const totalTime = end - start;
          const avgTime = totalTime / iterations;
          
          console.log('Performance Results:');
          console.log('Total time for ' + iterations + ' operations: ' + totalTime + 'ms');
          console.log('Average time per operation: ' + avgTime.toFixed(2) + 'ms');
          
          // Fallback mode uses localStorage which should be very fast
          // Use a stricter threshold to detect performance regressions
          const THRESHOLD_MS = 50;
          
          if (avgTime > THRESHOLD_MS) {
            console.log('⚠ Warning: Average latency exceeds ' + THRESHOLD_MS + 'ms');
          } else {
            console.log('✓ Performance within acceptable limits');
          }
        }
        
        measurePerformance();
        "
        
    - name: Check bundle size
      run: |
        echo "Checking JavaScript bundle sizes..."
        du -h ipfs-client.js
        du -h script.js
        echo "✓ Bundle size check complete"

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run npm audit
      run: npm audit --audit-level=moderate
      
    - name: Check for XSS vulnerabilities
      run: |
        echo "Checking for potential XSS vulnerabilities..."
        UNSAFE_PATTERNS=0
        
        # Check for innerHTML manipulation
        if grep -rE "innerHTML\s*[+=]" script.js 2>/dev/null; then
          echo "⚠ Warning: innerHTML manipulation detected"
          UNSAFE_PATTERNS=$((UNSAFE_PATTERNS + 1))
        fi
        
        # Check for outerHTML manipulation
        if grep -rE "outerHTML\s*[+=]" script.js 2>/dev/null; then
          echo "⚠ Warning: outerHTML manipulation detected"
          UNSAFE_PATTERNS=$((UNSAFE_PATTERNS + 1))
        fi
        
        # Check for document.write
        if grep -r "document\.write" script.js 2>/dev/null; then
          echo "⚠ Warning: document.write detected"
          UNSAFE_PATTERNS=$((UNSAFE_PATTERNS + 1))
        fi
        
        # Verify safe DOM manipulation is being used
        if ! grep -q "createElement\|textContent" script.js; then
          echo "⚠ Warning: No safe DOM manipulation methods found"
          UNSAFE_PATTERNS=$((UNSAFE_PATTERNS + 1))
        fi
        
        if [ $UNSAFE_PATTERNS -gt 0 ]; then
          echo "✗ Found $UNSAFE_PATTERNS potential XSS vulnerability pattern(s)"
          exit 1
        else
          echo "✓ Safe DOM manipulation verified (using createElement/textContent)"
        fi

  build-and-deploy:
    name: Build and Verify Deployment
    runs-on: ubuntu-latest
    needs: [test, edge-case-testing, performance-monitoring]
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Verify all files present
      run: |
        echo "Verifying project structure..."
        test -f index.html && echo "✓ index.html present"
        test -f script.js && echo "✓ script.js present"
        test -f ipfs-client.js && echo "✓ ipfs-client.js present"
        test -f style.css && echo "✓ style.css present"
        test -f README.md && echo "✓ README.md present"
        echo "✓ All required files present"
        
    - name: Validate HTML
      run: |
        echo "HTML structure validation..."
        grep -q "ipfs-client.js" index.html && echo "✓ IPFS client script included"
        grep -q "ipfs-status" index.html && echo "✓ Status element present"
        grep -q "IpfsHttpClient" index.html && echo "✓ IPFS library CDN included"
        
    - name: Success notification
      run: echo "✓ CI/CD Pipeline completed successfully!"
